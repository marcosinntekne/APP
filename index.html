<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>App de Reportes con Login y Mejoras</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  label { display: block; margin-top: 10px; }
  textarea { width: 100%; height: 60px; }
  input, select, button { margin-top: 5px; }
  .report { border: 1px solid #ccc; padding: 10px; margin-top: 10px; }
  .hidden { display: none; }
  #printAllBtn { margin-bottom: 10px; }
</style>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body>

<h2>App de Reportes con Login y Mejoras</h2>

<div id="loginForm">
  <label>Usuario: <input type="text" id="loginUser" /></label>
  <label>Contraseña: <input type="password" id="loginPass" /></label>
  <button onclick="login()">Iniciar Sesión</button>
</div>

<div id="mainApp" class="hidden">
  <p>Bienvenido <span id="userName"></span> (<span id="userRole"></span>) 
    <button onclick="logout()">Cerrar sesión</button>
  </p>

  <div id="userManager" class="hidden">
    <h3>Gestión de usuarios</h3>
    <label>Nuevo Usuario: <input type="text" id="newUser" /></label>
    <label>Contraseña: <input type="password" id="newPass" /></label>
    <label>Rol:
      <select id="newRole">
        <option value="operario">Operario</option>
        <option value="jefe">Jefe de mantenimiento</option>
      </select>
    </label>
    <button onclick="addUser()">Agregar Usuario</button>
  </div>

  <div id="formulario">
    <label>Nombre de la máquina: <input type="text" id="machine" /></label>
    <label>Tarea a realizar: <textarea id="task"></textarea></label>
    <label>Comentarios: <textarea id="comments"></textarea></label>
    <label>Foto: <input type="file" id="photo" accept="image/*" multiple /></label>
    <button id="submitBtn">Cargar Reporte</button>
  </div>

  <button id="printAllBtn">Imprimir todos los reportes</button>

  <h3>Reportes cargados:</h3>
  <div id="reports"></div>
</div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyDnbKGnR0gkd5TexFWx_jiPFg6fDZRh6Cg",
    authDomain: "pruebamantenimiento-65b4e.firebaseapp.com",
    projectId: "pruebamantenimiento-65b4e",
    storageBucket: "pruebamantenimiento-65b4e.appspot.com",
    messagingSenderId: "18841963943",
    appId: "1:18841963943:web:e4ce31f8aa248c65e93a82"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  let currentUser = null;

  const loginForm = document.getElementById('loginForm');
  const mainApp = document.getElementById('mainApp');
  const userNameSpan = document.getElementById('userName');
  const userRoleSpan = document.getElementById('userRole');
  const userManager = document.getElementById('userManager');
  const photoInput = document.getElementById('photo');
  const reportsDiv = document.getElementById('reports');
  const printAllBtn = document.getElementById('printAllBtn');

  // Guardar usuario en localStorage para sesión persistente
  function saveUserToStorage(user) {
    localStorage.setItem('currentUser', JSON.stringify(user));
  }
  function loadUserFromStorage() {
    const u = localStorage.getItem('currentUser');
    return u ? JSON.parse(u) : null;
  }
  function clearUserStorage() {
    localStorage.removeItem('currentUser');
  }

  async function login() {
    const user = document.getElementById('loginUser').value.trim();
    const pass = document.getElementById('loginPass').value.trim();

    if (!user || !pass) return alert('Complete usuario y contraseña.');

    if (user === 'INNTEKNE' && pass === '1234') {
      currentUser = { name: 'INNTEKNE', role: 'fabricante' };
      saveUserToStorage(currentUser);
      showApp();
      return;
    }

    try {
      const snapshot = await db.collection('usuarios').where('name', '==', user).where('password', '==', pass).get();
      if (!snapshot.empty) {
        const doc = snapshot.docs[0];
        currentUser = doc.data();
        saveUserToStorage(currentUser);
        showApp();
      } else {
        alert('Usuario o contraseña incorrectos.');
      }
    } catch (e) {
      alert('Error al iniciar sesión: ' + e.message);
    }
  }

  function logout() {
    currentUser = null;
    clearUserStorage();
    loginForm.classList.remove('hidden');
    mainApp.classList.add('hidden');
  }

  function showApp() {
    loginForm.classList.add('hidden');
    mainApp.classList.remove('hidden');
    userNameSpan.textContent = currentUser.name;
    userRoleSpan.textContent = currentUser.role;
    if (currentUser.role === 'fabricante') userManager.classList.remove('hidden');
    else userManager.classList.add('hidden');
    subscribeReports(); // activa la actualización en tiempo real
  }

  async function addUser() {
    const name = document.getElementById('newUser').value.trim();
    const password = document.getElementById('newPass').value.trim();
    const role = document.getElementById('newRole').value;
    if (!name || !password) return alert('Complete todos los campos');
    try {
      await db.collection('usuarios').add({ name, password, role });
      alert('Usuario agregado');
    } catch (e) {
      alert('Error agregando usuario: ' + e.message);
    }
  }

  function createReportElement(doc) {
    const report = doc.data();
    const timestamp = report.timestamp?.toDate();
    const fechaHora = timestamp ? timestamp.toLocaleString() : 'Fecha no disponible';

    const div = document.createElement('div');
    div.classList.add('report');

    div.innerHTML = `
      <strong>Máquina:</strong> ${report.machine}<br>
      <strong>Tarea:</strong> ${report.task}<br>
      <strong>Comentarios:</strong> ${report.comments}<br>
      ${report.photos ? report.photos.map(photo => `<img src="${photo}" style="max-width:200px; margin:5px"/>`).join('') : ''}
      <br>
      <em>Por: ${report.user} (${report.role})</em><br>
      <em>Fecha y hora: ${fechaHora}</em>
    `;

    // Botón imprimir individual
    const printBtn = document.createElement('button');
    printBtn.textContent = 'Imprimir reporte';
    printBtn.onclick = () => printReport(report, fechaHora);
    div.appendChild(printBtn);

    // Botón eliminar para jefe
    if (currentUser.role === 'jefe') {
      const deleteBtn = document.createElement('button');
      deleteBtn.textContent = 'Eliminar';
      deleteBtn.style.marginLeft = '10px';
      deleteBtn.onclick = async () => {
        if (confirm('¿Seguro que desea eliminar este reporte?')) {
          await db.collection('reportes').doc(doc.id).delete();
        }
      };
      div.appendChild(deleteBtn);
    }

    return div;
  }

  function printReport(report, fechaHora) {
    const content = `
      <h3>Reporte de Mantenimiento</h3>
      <p><strong>Máquina:</strong> ${report.machine}</p>
      <p><strong>Tarea:</strong> ${report.task}</p>
      <p><strong>Comentarios:</strong> ${report.comments}</p>
      ${report.photos ? report.photos.map(photo => `<img src="${photo}" style="max-width:300px; margin:5px"/>`).join('') : ''}
      <p><em>Por: ${report.user} (${report.role})</em></p>
      <p><em>Fecha y hora: ${fechaHora}</em></p>
    `;
    const printWindow = window.open('', '', 'width=600,height=600');
    printWindow.document.write(content);
    printWindow.document.close();
    printWindow.focus();
    printWindow.print();
    printWindow.close();
  }

  function printAllReports(reportsArray) {
    const content = reportsArray.map(report => {
      const fechaHora = report.timestamp?.toDate().toLocaleString() || 'Fecha no disponible';
      return `
        <hr>
        <h3>Reporte de Mantenimiento</h3>
        <p><strong>Máquina:</strong> ${report.machine}</p>
        <p><strong>Tarea:</strong> ${report.task}</p>
        <p><strong>Comentarios:</strong> ${report.comments}</p>
        ${report.photos ? report.photos.map(photo => `<img src="${photo}" style="max-width:300px; margin:5px"/>`).join('') : ''}
        <p><em>Por: ${report.user} (${report.role})</em></p>
        <p><em>Fecha y hora: ${fechaHora}</em></p>
      `;
    }).join('');

    const printWindow = window.open('', '', 'width=800,height=800');
    printWindow.document.write(content);
    printWindow.document.close();
    printWindow.focus();
    printWindow.print();
    printWindow.close();
  }

  let reportsList = [];

  function subscribeReports() {
    db.collection('reportes').orderBy('timestamp', 'desc').onSnapshot(snapshot => {
      reportsDiv.innerHTML = '';
      reportsList = [];
      snapshot.forEach(doc => {
        reportsList.push(doc.data());
        const div = createReportElement(doc);
        reportsDiv.appendChild(div);
      });
    });
  }

  printAllBtn.onclick = () => {
    if (reportsList.length === 0) return alert('No hay reportes para imprimir.');
    printAllReports(reportsList);
  };

  async function uploadPhotos(files) {
    if (!files.length) return [];
    const urls = [];
    // Aquí idealmente subirías fotos a Firebase Storage y obtendrás URLs, 
    // pero por simplicidad retornamos URL de objeto local (no válido para producción).
    // Implementar subida real si querés que funcione con fotos.
    for (const file of files) {
      urls.push(URL.createObjectURL(file));
    }
    return urls;
  }

  document.getElementById('submitBtn').onclick = async () => {
    const machine = document.getElementById('machine').value.trim();
    const task = document.getElementById('task').value.trim();
    const comments = document.getElementById('comments').value.trim();
    const photosFiles = photoInput.files;

    if (!machine || !task) return alert('Complete máquina y tarea.');

    const photos = await uploadPhotos(photosFiles);

    await db.collection('reportes').add({
      machine,
      task,
      comments,
      photos,
      user: currentUser.name,
      role: currentUser.role,
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });

    alert('Reporte cargado.');

    document.getElementById('machine').value = '';
    document.getElementById('task').value = '';
    document.getElementById('comments').value = '';
    photoInput.value = '';
  };

  // Auto login si está guardado
  window.onload = () => {
    const storedUser = loadUserFromStorage();
    if (storedUser) {
      currentUser = storedUser;
      showApp();
    }
  };
</script>
</body>
</html>
